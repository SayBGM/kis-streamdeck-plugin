<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8">
  <title>미국주식 시세 설정</title>
  <link rel="stylesheet" href="sdpi.css">
  <style>
    .sdpi-error {
      color: #ff5252;
      font-size: 11px;
      padding: 2px 8px 4px;
      display: none;
    }
    .sdpi-test-result {
      font-size: 12px;
      padding: 4px 8px;
      display: none;
    }
    .sdpi-test-result.success { color: #00c853; }
    .sdpi-test-result.error { color: #ff5252; }
  </style>
</head>
<body>
  <div class="sdpi-wrapper">

    <!-- ─── KIS API 설정 (전역) ─── -->
    <div class="sdpi-group">
      <div class="sdpi-group-label">KIS API 설정 (공통)</div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">App Key</div>
        <div class="sdpi-item-value">
          <input type="password" id="appKey" placeholder="App Key 입력">
        </div>
      </div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">App Secret</div>
        <div class="sdpi-item-value">
          <input type="password" id="appSecret" placeholder="App Secret 입력">
        </div>
      </div>

      <div class="sdpi-help">
        한국투자증권 Open API에서 발급받은 키를 입력하세요. 모든 버튼에 공통 적용됩니다.
      </div>

      <!-- 연결 테스트 버튼 -->
      <div class="sdpi-item">
        <div class="sdpi-item-label">연결</div>
        <button id="testConnectionBtn" class="sdpi-item-value">연결 테스트</button>
      </div>
      <div id="testConnectionResult" class="sdpi-test-result"></div>
    </div>

    <div class="sdpi-separator"></div>

    <!-- ─── 미국주식 설정 (액션별) ─── -->
    <div class="sdpi-group">
      <div class="sdpi-group-label">미국주식 설정</div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">티커 심볼</div>
        <div class="sdpi-item-value">
          <input type="text" id="ticker" placeholder="AAPL">
        </div>
      </div>
      <div id="tickerError" class="sdpi-error">1~6자 영문 티커를 입력하세요 (예: AAPL)</div>
      <div class="sdpi-help">미국주식 티커 심볼을 입력하세요 (예: AAPL, TSLA, MSFT)</div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">거래소</div>
        <div class="sdpi-item-value">
          <select id="exchange">
            <option value="NAS">NASDAQ</option>
            <option value="NYS">NYSE</option>
            <option value="AMS">AMEX</option>
          </select>
        </div>
      </div>
      <div class="sdpi-help">종목이 상장된 거래소를 선택하세요</div>

      <div class="sdpi-item">
        <div class="sdpi-item-label">종목명</div>
        <div class="sdpi-item-value">
          <input type="text" id="stockName" placeholder="Apple">
        </div>
      </div>
      <div class="sdpi-help">Stream Deck 키에 표시할 종목명을 입력하세요</div>
    </div>

    <!-- 상태 메시지 -->
    <div id="statusMessage" class="sdpi-status info" style="display:none;"></div>

  </div>

  <script src="sdpi.js"></script>
  <script>
    var tickerValid = true;

    // ─── 전역 설정 수신 ───
    document.addEventListener("piDidReceiveGlobalSettings", function (evt) {
      var settings = evt.detail || {};
      document.getElementById("appKey").value = settings.appKey || "";
      document.getElementById("appSecret").value = settings.appSecret || "";
    });

    // ─── 액션 설정 수신 ───
    document.addEventListener("piDidReceiveSettings", function (evt) {
      var settings = evt.detail || {};
      document.getElementById("ticker").value = settings.ticker || "";
      document.getElementById("exchange").value = settings.exchange || "NAS";
      document.getElementById("stockName").value = settings.stockName || "";
      validateTicker(settings.ticker || "");
    });

    // ─── 전역 설정 저장 (App Key / App Secret 변경 시) ───
    function saveGlobalSettings() {
      setGlobalSettings({
        appKey: document.getElementById("appKey").value.trim(),
        appSecret: document.getElementById("appSecret").value.trim(),
      });
      showStatus("API 설정이 저장되었습니다", "success");
    }

    document.getElementById("appKey").addEventListener("change", saveGlobalSettings);
    document.getElementById("appSecret").addEventListener("change", saveGlobalSettings);

    // ─── 티커 실시간 검증 ───
    function validateTicker(value) {
      var isValid = /^[A-Z]{1,6}$/i.test(value);
      var errorEl = document.getElementById("tickerError");
      if (value.length > 0 && !isValid) {
        errorEl.style.display = "block";
        tickerValid = false;
      } else {
        errorEl.style.display = "none";
        tickerValid = true;
      }
      return isValid || value.length === 0;
    }

    document.getElementById("ticker").addEventListener("input", function () {
      validateTicker(this.value);
    });

    // ─── 액션 설정 저장 (티커 / 거래소 / 종목명 변경 시) ───
    function saveActionSettings() {
      if (!tickerValid) return;
      setSettings({
        ticker: document.getElementById("ticker").value.trim().toUpperCase(),
        exchange: document.getElementById("exchange").value,
        stockName: document.getElementById("stockName").value.trim(),
      });
      showStatus("종목 설정이 저장되었습니다", "success");
    }

    document.getElementById("ticker").addEventListener("change", function () {
      if (validateTicker(this.value)) {
        saveActionSettings();
      }
    });
    document.getElementById("exchange").addEventListener("change", saveActionSettings);
    document.getElementById("stockName").addEventListener("change", saveActionSettings);

    // ─── 연결 테스트 ───
    document.getElementById("testConnectionBtn").addEventListener("click", function () {
      var btn = document.getElementById("testConnectionBtn");
      var resultEl = document.getElementById("testConnectionResult");
      btn.disabled = true;
      btn.textContent = "테스트 중...";
      resultEl.style.display = "none";

      sendToPlugin({ event: "testConnection" });
    });

    // ─── 연결 테스트 결과 수신 ───
    document.addEventListener("sendToPropertyInspector", function (evt) {
      var payload = evt.detail || {};
      if (payload.event !== "testConnectionResult") return;

      var btn = document.getElementById("testConnectionBtn");
      var resultEl = document.getElementById("testConnectionResult");
      btn.disabled = false;
      btn.textContent = "연결 테스트";

      if (payload.success) {
        resultEl.textContent = "연결 성공";
        resultEl.className = "sdpi-test-result success";
        resultEl.style.display = "block";
        setTimeout(function () { resultEl.style.display = "none"; }, 3000);
      } else {
        var errorMsg = "연결 실패";
        if (payload.errorType === "AUTH_FAIL") {
          errorMsg = "연결 실패: 인증 오류";
        } else if (payload.errorType === "NETWORK_ERROR") {
          errorMsg = "연결 실패: 네트워크 오류";
        } else if (payload.errorType === "NO_CREDENTIAL") {
          errorMsg = "연결 실패: API 키를 먼저 설정하세요";
        }
        resultEl.textContent = errorMsg;
        resultEl.className = "sdpi-test-result error";
        resultEl.style.display = "block";
        setTimeout(function () { resultEl.style.display = "none"; }, 5000);
      }
    });

    // ─── 상태 메시지 표시 ───
    function showStatus(message, type) {
      var el = document.getElementById("statusMessage");
      el.textContent = message;
      el.className = "sdpi-status " + type;
      el.style.display = "block";
      setTimeout(function () {
        el.style.display = "none";
      }, 2000);
    }
  </script>
</body>
</html>
